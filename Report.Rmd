---
  header-includes:
  - \usepackage{fancyhdr}
- \fancyfoot[CO,CE]{MIDMO-Group - http://www.pkmetrix.eu - JMU Wuerzburg - Pharmazie}
- \fancyfoot[LE,RO]{\thepage}
- \usepackage{fontspec}
- \setmainfont{FreeSans}

title: "TDM Report - Vancomycin"
output: 
  pdf_document:
  latexengine: xelatex
df_print: paged
date: "`r format(Sys.time(), '%d.%B %Y')`"


---
  \setmainfont{FreeSans}
\addtolength{\headheight}{1.0cm} 
\pagestyle{fancyplain} 
\rhead{\includegraphics[height=1.2cm]{./logo_rechts.png}} 
\lhead{\includegraphics[height=1.2cm]{./logo_links.png}}
\renewcommand{\headrulewidth}{0pt}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Patient characteristics**


Patient ID: **`r input$ID`** 
  
  Body weight: **`r input$WT`** kg 

Height: **`r input$HT`** cm 

`r if(input$TDM == 2){
  "Maximum a posteriori result"
} else if(input$TDM ==3){
  "Results of Markov-Chain-Monte-Carlo simulation"}` 


``` {r ind_pars, echo=FALSE}
if(!is.null(values$MAP_result) && input$TDM == 2) {
  MAP_etas <- values$MAP_result$post_etas
  df.ind_pars = data.frame(ETA1=MAP_etas[1], ETA2=MAP_etas[2])
  row.names(df.ind_pars) = NULL
  kable(df.ind_pars, format = "latex", 
        col.names = c("ETA1", "ETA2"))  %>%
    kable_styling(position = "left")
}

if(!is.null(values$MCMC_result) && input$TDM == 3){
  
  MCMC_etas <-values$MCMC_result$post_max_pars
  df.ind_pars = data.frame(ETA1=MCMC_etas[1], ETA2=MCMC_etas[2])
  row.names(df.ind_pars) = NULL
  kable(df.ind_pars, format = "latex", 
        col.names = c("ETA1", "ETA2"))  %>%
    kable_styling(position = "left")
}

```


# **Dosing history**

`r HTML(values$text_cumul_dose)`

Administered doses of Mitotane (Last 10 doses)

``` {r scheme, echo=FALSE}
kable(tail(values$DF_scheme), format = "latex",
      col.names = c("Date", "Time", "Dose [mg]")) %>%
  kable_styling(position = "left")
```

# **TDM history**

Measured Plasmaconcentrations (Last 10 concentrations)

``` {r tdm, echo=FALSE}
kable(tail(values$DF_tdm), format = "latex",
      col.names = c("Date", "Time", "Concentration [mg/L]")) %>%
  kable_styling(position = "left")
```

# **Simulated Plasmaconcentration**

`r HTML(values$text_auc)`

Saturation phase to forecast: **`r input$SAT_DOSE`** mg for **`r input$SAT_ADDL`** days  

Sustainment phase to forecast: **`r input$SUS_DOSE`** mg for **`r input$SUS_ADDL`** days  

`r HTML(values$text_forecast)`



```{r simulation, echo=FALSE}
plot(values$curr_pl1)

```

# **Parameter estimation**

`r HTML(values$text_etas)`

```{r mcmc_res, echo=FALSE}
if(input$TDM==3) {
  
  if (!is.null(values$mcmc_diag_plot)) {
    a <- values$mcmc_diag_plot
    grid.arrange(a$p_iter_ETA1,a$p_dens_ETA1, 
                 a$p_iter_ETA2, a$p_dens_ETA2,
                 nrow=2, ncol=2)
  }
} else if (input$TDM==2) {
  if (!is.null(values$map_diag_plot)) {
    
    a <- values$map_diag_plot
    grid.arrange(a$p_dens_ETA1, 
                 a$p_dens_ETA2,
                 nrow=1, ncol=2)
  }
} else {
  if (!is.null(values$eta_diag_plot)) {
    
    a <- values$eta_diag_plot
    grid.arrange(a$p_dens_ETA1, 
                 a$p_dens_ETA2,
                 nrow=1, ncol=2)
  }
}


```
